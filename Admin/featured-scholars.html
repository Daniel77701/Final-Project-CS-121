<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="icons_admin/logo.png" type="image/x-icon">
    <title>Scholarship Tracker System</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="admin_css/featured-scholar.css"> 
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
</head>
<body>
    <!-- Header Section -->
    <header id="header">
        <div class="logo">
            <img src="icons_admin/logo.png" alt="Logo" width="40">
            <span>Scholarship Tracker System</span>
        </div>
        <div class="welcome d-flex align-items-center">
            <i class="fas fa-bell"></i> <span class="badge badge-light ml-2">1</span>
            <span class="ml-4">Welcome, Admin</span>
            <i class="fas fa-user ml-2"></i>
            <a href="settings.html">
                <img src="icons_admin/white_settings.png" alt="Settings Icon" style="width: 30px; height: 30px; margin-left: 10px;">
            </a> 
        </div>
    </header>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav id="sidebar" class="col-12 col-md-3 col-lg-2 sidebar bg-light p-3 collapse d-md-block">
                <ul class="nav flex-column">
                    <li class="nav-item"><a class="nav-link" href="admin-dashboard.php"><img src="icons_admin/dashboard.png" alt="Dashboard Icon"> Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link" href="scholars.php"><img src="icons_admin/scholars.png" alt="Scholars Icon"> Scholars</a></li>
                    <li class="nav-item"><a class="nav-link" href="scholarship.php"><img src="icons_admin/scholarships.png" alt="Scholarship Icon"> Scholarship</a></li>
                    <li class="nav-item"><a class="nav-link" href="scholarship-request.php"><img src="icons_admin/scholarship_request.png" alt="Scholarship Request Icon"> Scholarship Request</a></li>
                    <li class="nav-item"><a class="nav-link" href="schema.php"><img src="icons_admin/view schema.png" alt="Schema Icon"> Schema</a></li>
                    <li class="nav-item"><a class="nav-link" href="FAQ'S.php"><img src="icons_admin/exam_management.png" alt="FAQ'S Icon"> FAQ'S</a></li>
                    <li class="nav-item"><a class="nav-link" href="announcement.php"><img src="icons_admin/announcement.png" alt="Announcement Icon"> Announcement</a></li>
                    <li class="nav-item"><a class="nav-link" href="feedback.php"><img src="icons_admin/feedback.png" alt="Feedback Icon"> Feedback</a></li>
                    <li class="nav-item"><a class="nav-link active" href="featured-scholars.html"><img src="icons_admin/featured_scholars.png" alt="Featured Scholars Icon"> Featured Scholars</a></li>
                    <li class="nav-item"><a class="nav-link" href="settings.php"><img src="icons_admin/setting.png" alt="Settings Icon"> Settings</a></li>
                    <li class="nav-item"><a class="nav-link" href="useraccount.php"><img src="icons_admin/useraccount.png" alt="User Account Icon"> User Account</a></li>
                    <li class="nav-item"><a class="nav-link" href="userlogs.php"><img src="icons_admin/userlogs.png" alt="User Logs Icon"> User Logs</a></li>
                </ul>
            </nav>

            <div class="scholarship-section">
                <div class="title-box">
                    <h2>Featured Scholars 
                        <a href="settings.html"><img src="icons_admin/setting.png" alt="Settings Icon" style="width: 30px; height: 30px;"></a>
                    </h2> 
                    <hr> 
                    <div class="button-container">
                        <button class="add-featured" id="add-scholar-btn">Create Featured Scholar</button>
                    </div>
                </div>

                <div class="table-box">
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Course</th>
                                <th>Scholarship Name</th>
                                <th>Message</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="scholar-table">
                            <!-- Scholars will be loaded here dynamically via AJAX -->
                        </tbody>
                    </table>
                    <div class="footer">Showing 0 to 0 of 0 entries</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap and jQuery Scripts -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <script>
        $(document).ready(function() {
            // Update the add scholar button click handler
            $('#add-scholar-btn').click(function() {
                Swal.fire({
                    title: 'Add Featured Scholar',
                    html: `
                        <form id="addScholarForm" class="text-left">
                            <div class="form-group">
                                <label for="subject">Name:</label>
                                <input type="text" class="form-control" name="subject" required>
                            </div>
                            <div class="form-group">
                                <label for="course">Course:</label>
                                <input type="text" class="form-control" name="course" required>
                            </div>
                            <div class="form-group">
                                <label for="year_graduated">Scholarship Name:</label>
                                <input type="text" class="form-control" name="year_graduated" required>
                            </div>
                            <div class="form-group">
                                <label for="message">Message:</label>
                                <textarea class="form-control" name="message" required></textarea>
                            </div>
                            <div class="form-group">
                                <label for="status">Status:</label>
                                <select class="form-control" name="status" required>
                                    <option value="">Select Status</option>
                                    <option value="Active">Active</option>
                                    <option value="Inactive">Inactive</option>
                                </select>
                            </div>
                        </form>
                    `,
                    showCancelButton: true,
                    confirmButtonText: 'Add Scholar',
                    cancelButtonText: 'Cancel',
                    width: '500px',
                    preConfirm: () => {
                        const form = document.getElementById('addScholarForm');
                        if (!form.checkValidity()) {
                            Swal.showValidationMessage('Please fill in all required fields');
                            return false;
                        }
                        return {
                            action: 'add_scholar',
                            subject: form.querySelector('[name="subject"]').value,
                            course: form.querySelector('[name="course"]').value,
                            year_graduated: form.querySelector('[name="year_graduated"]').value,
                            message: form.querySelector('[name="message"]').value,
                            status: form.querySelector('[name="status"]').value
                        };
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        console.log('Sending data:', result.value); // Debug log
                        $.ajax({
                            url: 'featured-scholars_handler.php',
                            type: 'POST',
                            data: result.value,
                            dataType: 'json',
                            success: function(response) {
                                console.log('Response:', response); // Debug log
                                let result = typeof response === 'string' ? JSON.parse(response) : response;
                                if (result.status === 'success') {
                                    Swal.fire({
                                        title: 'Success!',
                                        text: 'Scholar added successfully',
                                        icon: 'success',
                                        timer: 1500
                                    });
                                    fetchScholars();
                                } else {
                                    Swal.fire({
                                        title: 'Error!',
                                        text: result.message || 'Failed to add scholar',
                                        icon: 'error'
                                    });
                                }
                            },
                            error: function(xhr, status, error) {
                                console.error('Ajax error:', error); // Debug log
                                console.error('Response:', xhr.responseText); // Debug log
                                Swal.fire({
                                    title: 'Error!',
                                    text: 'An error occurred while adding the scholar: ' + error,
                                    icon: 'error'
                                });
                            }
                        });
                    }
                });
            });
    
            // Delete scholar
            $(document).on('click', '.delete-btn', function() {
                let scholarId = $(this).data('id');
    
                Swal.fire({
                    title: 'Are you sure?',
                    text: "You won't be able to revert this!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Yes, delete it!'
                }).then((result) => {
                    if (result.isConfirmed) {
                        $.ajax({
                            url: 'featured-scholars_handler.php',
                            type: 'POST',
                            dataType: 'json',
                            data: { action: 'delete_scholar', scholar_id: scholarId },
                            success: function(response) {
                                let result = typeof response === 'string' ? JSON.parse(response) : response;
                                if (result.status === 'success') {
                                    Swal.fire({
                                        title: 'Deleted!',
                                        text: result.message,
                                        icon: 'success',
                                        timer: 2000,
                                        showConfirmButton: false
                                    });
                                    fetchScholars();
                                } else {
                                    Swal.fire({
                                        title: 'Error!',
                                        text: result.message,
                                        icon: 'error'
                                    });
                                }
                            },
                            error: function(xhr, status, error) {
                                console.error('Delete error:', error);
                                console.error('Response:', xhr.responseText);
                                Swal.fire({
                                    title: 'Error!',
                                    text: 'Failed to delete scholar: ' + error,
                                    icon: 'error'
                                });
                            }
                        });
                    }
                });
            });
    
            // Fetch scholars function
            function fetchScholars() {
                $.ajax({
                    url: 'featured-scholars_handler.php',
                    type: 'GET',
                    dataType: 'json',
                    success: function(response) {
                        console.log('Fetched data:', response); // Debug log
                        let scholars = response.scholar_data || [];
                        let tableRows = '';
                        if (scholars.length === 0) {
                            tableRows = '<tr><td colspan="6" class="text-center">No scholars found</td></tr>';
                        } else {
                        scholars.forEach(function(scholar) {
                            tableRows += `
                                <tr>
                                    <td>${scholar.subject}</td>
                                    <td>${scholar.course}</td>
                                    <td>${scholar.year_graduated}</td>
                                    <td>${scholar.message}</td>
                                    <td>${scholar.status}</td>
                                    <td>
                                        <button class="btn btn-danger btn-sm delete-btn" data-id="${scholar.id}">Delete</button>
                                    </td>
                                </tr>
                            `;
                        });
                        }
                        $('#scholar-table').html(tableRows);
                        // Update the entries count
                        $('.footer').text(`Showing ${scholars.length} of ${scholars.length} entries`);
                    },
                    error: function(xhr, status, error) {
                        console.error('Error fetching scholars:', error);
                        console.error('Response:', xhr.responseText);
                        $('#scholar-table').html('<tr><td colspan="6" class="text-center text-danger">Error loading scholars</td></tr>');
                    }
                });
            }
    
            // Call fetchScholars when page loads
            fetchScholars();
        });
    </script>
</body>
</html>